#!/bin/bash

# ==============================================================================
# Git ä»“åº“è‡ªåŠ¨åŒ–æ›´æ–°ä¸æ ‡ç­¾ä¸Šä¼ è„šæœ¬
# è„šæœ¬ä½œè€…ï¼šAI
# ç‰ˆæœ¬ï¼š1.0.0
# åŠŸèƒ½ï¼š
# 1. è‡ªåŠ¨æ‹‰å–è¿œç¨‹ä»“åº“æœ€æ–°ä»£ç 
# 2. è‡ªåŠ¨æš‚å­˜æ‰€æœ‰ä¿®æ”¹ï¼Œå¹¶æç¤ºç”¨æˆ·è¾“å…¥æäº¤ä¿¡æ¯
# 3. æ¨é€æœ¬åœ°æäº¤åˆ°è¿œç¨‹ä»“åº“
# 4. å¼•å¯¼ç”¨æˆ·åˆ›å»ºå¹¶æ¨é€æ–°çš„Gitæ ‡ç­¾
# ==============================================================================

echo "ğŸš€ å¼€å§‹æ›´æ–° GitHub ä»“åº“..."

# 1. æ£€æŸ¥å½“å‰ç›®å½•æ˜¯å¦ä¸º Git ä»“åº“
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "âŒ é”™è¯¯ï¼šå½“å‰ç›®å½•ä¸æ˜¯ä¸€ä¸ª Git ä»“åº“ã€‚è¯·åœ¨ä»“åº“æ ¹ç›®å½•æ‰§è¡Œæ­¤è„šæœ¬ã€‚"
    exit 1
fi

# 2. æ‹‰å–æœ€æ–°ä»£ç 
echo "â¡ï¸ æ‹‰å–è¿œç¨‹ä»“åº“æœ€æ–°ä»£ç ..."
if ! git pull; then
    echo "âŒ é”™è¯¯ï¼šæ‹‰å–æœ€æ–°ä»£ç å¤±è´¥ã€‚å¯èƒ½å­˜åœ¨åˆå¹¶å†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³åé‡è¯•ã€‚"
    exit 1
fi
echo "âœ… ä»£ç å·²æˆåŠŸåŒæ­¥åˆ°æœ€æ–°ã€‚"

# 3. æš‚å­˜å¹¶æäº¤ä¿®æ”¹
echo "â¡ï¸ æš‚å­˜æ‰€æœ‰æ–‡ä»¶å˜æ›´..."
git add .

read -p "è¯·è¾“å…¥æäº¤ä¿¡æ¯ï¼ˆä¾‹å¦‚: 'feat: add new feature'ï¼‰ï¼š " commit_message

if [[ -z "$commit_message" ]]; then
    echo "âŒ é”™è¯¯ï¼šæäº¤ä¿¡æ¯ä¸èƒ½ä¸ºç©ºã€‚"
    exit 1
fi

git commit -m "$commit_message"
echo "âœ… æäº¤æˆåŠŸã€‚"

# 4. æ¨é€æäº¤
echo "â¡ï¸ æ¨é€æäº¤åˆ°è¿œç¨‹ä»“åº“..."
if ! git push; then
    echo "âŒ é”™è¯¯ï¼šæ¨é€å¤±è´¥ã€‚å¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜æˆ–è¿œç¨‹ä»“åº“å·²æ›´æ–°ï¼Œè¯·å†æ¬¡è¿è¡Œè„šæœ¬ã€‚"
    exit 1
fi
echo "âœ… ä»£ç å·²æˆåŠŸæ¨é€ã€‚"

# 5. åˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾
echo ""
echo "----------------------------------------"
echo "ğŸ·ï¸ å¼€å§‹å¤„ç† Git æ ‡ç­¾..."
read -p "è¯·è¾“å…¥æ–°çš„ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¾‹å¦‚: 'v1.0.0' æˆ– 'v1.1.0'ï¼‰ï¼š " tag_name

if [[ -z "$tag_name" ]]; then
    echo "âœ… è·³è¿‡æ ‡ç­¾åˆ›å»ºï¼Œè„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚"
    exit 0
fi

if git rev-parse "$tag_name" > /dev/null 2>&1; then
    echo "âš ï¸ è­¦å‘Šï¼šæ ‡ç­¾ '$tag_name' å·²å­˜åœ¨ã€‚è¯·ä½¿ç”¨ä¸€ä¸ªæ–°æ ‡ç­¾åã€‚"
else
    # åˆ›å»ºæœ¬åœ°æ ‡ç­¾
    git tag -a "$tag_name" -m "Release $tag_name"
    echo "âœ… æœ¬åœ°æ ‡ç­¾ '$tag_name' å·²åˆ›å»ºã€‚"

    # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
    git push origin "$tag_name"
    echo "âœ… æ ‡ç­¾ '$tag_name' å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚"
fi

echo "ğŸ‰ è„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚ä»“åº“å·²æ›´æ–°å¹¶ä¸Šä¼ æ ‡ç­¾ã€‚"